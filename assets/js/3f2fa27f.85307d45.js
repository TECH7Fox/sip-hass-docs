"use strict";(self.webpackChunksip_hass_docs=self.webpackChunksip_hass_docs||[]).push([[5222],{3408:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"add-on/guides/vpn","title":"VPN Guide (WireGuard)","description":"This guide helps you configure the Asterisk add-on to work properly with VoIP calls over a WireGuard VPN connection. Without proper configuration, you may experience one-way audio or dropped calls when connecting remotely.","source":"@site/docs/add-on/guides/vpn.md","sourceDirName":"add-on/guides","slug":"/add-on/guides/vpn","permalink":"/sip-hass-docs/docs/add-on/guides/vpn","draft":false,"unlisted":false,"editUrl":"https://github.com/TECH7Fox/sip-hass-docs/edit/main/docs/add-on/guides/vpn.md","tags":[{"inline":true,"label":"VPN","permalink":"/sip-hass-docs/docs/tags/vpn"},{"inline":true,"label":"WireGuard","permalink":"/sip-hass-docs/docs/tags/wire-guard"},{"inline":true,"label":"Network","permalink":"/sip-hass-docs/docs/tags/network"},{"inline":true,"label":"NAT","permalink":"/sip-hass-docs/docs/tags/nat"},{"inline":true,"label":"RTP","permalink":"/sip-hass-docs/docs/tags/rtp"}],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"VPN Guide (WireGuard)","tags":["VPN","WireGuard","Network","NAT","RTP"]},"sidebar":"addonSidebar","previous":{"title":"Softphone","permalink":"/sip-hass-docs/docs/add-on/guides/softphone"}}');var s=t(4848),o=t(8453);const r={sidebar_position:5,title:"VPN Guide (WireGuard)",tags:["VPN","WireGuard","Network","NAT","RTP"]},a=void 0,d={},l=[{value:"Requirements",id:"requirements",level:2},{value:"Asterisk Add-On Configuration",id:"asterisk-add-on-configuration",level:2},{value:"Transport Configuration",id:"transport-configuration",level:3},{value:"Extension Template Configuration",id:"extension-template-configuration",level:3},{value:"WireGuard Add-On Configuration",id:"wireguard-add-on-configuration",level:2},{value:"Home Assistant Configuration",id:"home-assistant-configuration",level:2},{value:"Shell Command",id:"shell-command",level:3},{value:"Startup Automation",id:"startup-automation",level:3},{value:"Restart Home Assistant",id:"restart-home-assistant",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Summary",id:"summary",level:2}];function c(e){const n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"This guide helps you configure the Asterisk add-on to work properly with VoIP calls over a WireGuard VPN connection. Without proper configuration, you may experience one-way audio or dropped calls when connecting remotely."}),"\n",(0,s.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,s.jsx)(n.p,{children:"For this guide you will need the following:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Working Asterisk Add-on"}),"\n",(0,s.jsx)(n.li,{children:"WireGuard Add-on installed and configured"}),"\n",(0,s.jsx)(n.li,{children:"Basic understanding of network configuration"}),"\n",(0,s.jsx)(n.li,{children:"Administrative access to Home Assistant"}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsx)(n.p,{children:"This configuration involves modifying network settings and iptables rules. Make sure you understand the changes before applying them, and have a backup of your current configuration."})}),"\n",(0,s.jsx)(n.h2,{id:"asterisk-add-on-configuration",children:"Asterisk Add-On Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"transport-configuration",children:"Transport Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"pjsip_custom.conf"})," file, add the transport configuration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-editorconfig",metastring:'title="pjsip_custom.conf"',children:"[transport-udp]\ntype=transport\nprotocol=udp\nbind=0.0.0.0:5060  ; Binds to all IP addresses on port 5060\n; --- Network and NAT Configuration ---\n; This is the most critical part for your use case.\n; Add your local LAN and the VPN subnet here.\n; Asterisk will treat any traffic from these networks as internal.\nlocal_net=192.168.1.0/24   ; Your main LAN subnet - CHANGE THIS IF YOU USE A DIFFERENT NETWORK\nlocal_net=172.27.66.0/24   ; The VPN clients virtual addresses subnet - ASSUMING YOU'RE USING THE DEFAULT WIREGUARD ADD-ON SETTINGS\n"})}),"\n",(0,s.jsxs)(n.admonition,{type:"warning",children:[(0,s.jsxs)(n.p,{children:["Make sure to update the ",(0,s.jsx)(n.code,{children:"local_net"})," values to match your actual network configuration:"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Replace ",(0,s.jsx)(n.code,{children:"192.168.1.0/24"})," with your actual LAN subnet"]}),"\n",(0,s.jsx)(n.li,{children:"Verify the VPN subnet matches your WireGuard configuration"}),"\n"]})]}),"\n",(0,s.jsx)(n.h3,{id:"extension-template-configuration",children:"Extension Template Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["In the same ",(0,s.jsx)(n.code,{children:"pjsip_custom.conf"})," file, modify the extension template section:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-editorconfig",metastring:'title="pjsip_custom.conf"',children:"[sipjs-ext-endpoint](!)   ; <- This is the template header, it should already exist and you should add the following lines under it\nrtp_symmetric=yes\nforce_rport=yes\nrewrite_contact=yes\ndirect_media=no\n"})}),"\n",(0,s.jsx)(n.p,{children:"These settings ensure proper NAT traversal and RTP handling for VPN connections."}),"\n",(0,s.jsx)(n.h2,{id:"wireguard-add-on-configuration",children:"WireGuard Add-On Configuration"}),"\n",(0,s.jsx)(n.p,{children:'Add the following configuration to the "Server" section in the WireGuard add-on config page:'}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="WireGuard Add-on Server Configuration"',children:"post_up: >\n  iptables -A FORWARD -i %i -j ACCEPT ;  \n  iptables -A FORWARD -o %i -j ACCEPT ;\n  iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE ;  \n  iptables -t nat -I POSTROUTING 1 -p udp -s 172.30.32.1 -d  172.27.66.0/24 --sport 10000:20000 -j SNAT --to-source <YOUR HOME ASSISTANT IP ADDRESS HERE> ; \n  iptables -t nat -I POSTROUTING 1 -p udp -s 172.27.66.0/24 -d <YOUR HOME ASSISTANT IP ADDRESS HERE> --dport 10000:20000 -j RETURN  \npost_down: >\n  iptables -D FORWARD -i %i -j ACCEPT ;  \n  iptables -D FORWARD -o %i -j ACCEPT ;\n  iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE ;  \n  iptables -t nat -D POSTROUTING 1 -p udp -s 172.30.32.1 -d  172.27.66.0/24 --sport 10000:20000 -j SNAT --to-source <YOUR HOME ASSISTANT IP ADDRESS HERE> ; \n  iptables -t nat -D POSTROUTING 1 -p udp -s 172.27.66.0/24 -d <YOUR HOME ASSISTANT IP ADDRESS HERE> --dport 10000:20000 -j RETURN  \n"})}),"\n",(0,s.jsxs)(n.admonition,{type:"warning",children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Important Notes:"})}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Replace ",(0,s.jsx)(n.code,{children:"<YOUR HOME ASSISTANT IP ADDRESS HERE>"})," with your actual Home Assistant server IP address in ",(0,s.jsx)(n.strong,{children:"both"})," the ",(0,s.jsx)(n.code,{children:"post_up"})," and ",(0,s.jsx)(n.code,{children:"post_down"})," sections"]}),"\n",(0,s.jsx)(n.li,{children:"After saving this configuration, the UI will wrap the text but that's expected behavior"}),"\n",(0,s.jsx)(n.li,{children:"These iptables rules handle RTP traffic routing between VPN clients and the Asterisk server"}),"\n"]})]}),"\n",(0,s.jsx)(n.h2,{id:"home-assistant-configuration",children:"Home Assistant Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"shell-command",children:"Shell Command"}),"\n",(0,s.jsxs)(n.p,{children:["Add the following to your ",(0,s.jsx)(n.code,{children:"configuration.yaml"})," file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="configuration.yaml"',children:"shell_command:\n  add_vpn_rtp_route: ip route add 172.27.66.0/24 via 172.30.33.3\n"})}),"\n",(0,s.jsx)(n.p,{children:"This command adds a static route for VPN traffic to ensure proper routing of RTP packets."}),"\n",(0,s.jsx)(n.h3,{id:"startup-automation",children:"Startup Automation"}),"\n",(0,s.jsx)(n.p,{children:"Create the following automation in the Home Assistant UI to ensure the route is added after each restart:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="Home Assistant Automation"',children:'alias: Add static routes on Home Assistant startup\ndescription: "Add the necessary static route for VOIP calls to work over VPN after a HA restart"\ntriggers:\n  - event: start\n    trigger: homeassistant\nconditions: []\nactions:\n  - action: shell_command.add_vpn_rtp_route\n    data: {}\nmode: single\n'})}),"\n",(0,s.jsx)(n.h3,{id:"restart-home-assistant",children:"Restart Home Assistant"}),"\n",(0,s.jsxs)(n.p,{children:["After making these changes to ",(0,s.jsx)(n.code,{children:"configuration.yaml"}),", restart Home Assistant to apply the new shell command configuration."]}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.p,{children:"If you continue to experience issues:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify network subnets"})," - Ensure all IP ranges in the configuration match your actual network setup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check WireGuard logs"})," - Look for any iptables errors in the WireGuard add-on logs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Test connectivity"})," - Verify that VPN clients can reach the Home Assistant IP address"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Monitor Asterisk logs"})," - Check for NAT-related warnings or RTP timeout messages"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"After completing this configuration, you should have fully functional audio and video for VoIP calls even when connecting remotely over the WireGuard VPN. The configuration handles the complex NAT traversal and routing requirements that are necessary for real-time media streams."})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(6540);const s={},o=i.createContext(s);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);